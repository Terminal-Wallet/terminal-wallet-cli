import {
  encodeDeploySingleton,
  predictSingletonAddress,
} from "@gnosis-guild/zodiac-core";
import { TransactionRequest, ZeroHash } from "ethers";

// for reference: https://polygonscan.com/address/0x34bfec59154983c9ff5478e7dcc57eb7e8d3f5ba#code
const railgunMechBytecode =
  "0x60c060405234801561000f575f80fd5b5060405161056238038061056283398101604081905261002e91610083565b6001600160a01b03811660808190523060a08190526040805192835260208301919091527f395a37f76d5952499ce671a72044003fb77190777dbfc8c1b9521e270240f345910160405180910390a1506100b0565b5f60208284031215610093575f80fd5b81516001600160a01b03811681146100a9575f80fd5b9392505050565b60805160a0516104866100dc5f395f818160bc015260fb01525f81816071015261012e01526104865ff3fe608060405260043610610033575f3560e01c80635194544714610037578063a8f4f65c14610060578063af640d0f146100ab575b5f80fd5b61004a610045366004610333565b6100ec565b60405161005791906103d4565b60405180910390f35b34801561006b575f80fd5b506100937f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b039091168152602001610057565b3480156100b6575f80fd5b506100de7f000000000000000000000000000000000000000000000000000000000000000081565b604051908152602001610057565b6040516331a9108f60e11b81527f0000000000000000000000000000000000000000000000000000000000000000600482015260609033906001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690636352211e90602401602060405180830381865afa158015610173573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610197919061041f565b6001600160a01b0316146101fd5760405162461bcd60e51b815260206004820152602260248201527f4f6e6c792063616c6c61626c6520627920746865204d656368206f706572617460448201526137b960f11b60648201526084015b60405180910390fd5b5f8260ff165f0361026c57866001600160a01b0316868686604051610223929190610441565b5f6040518083038185875af1925050503d805f811461025d576040519150601f19603f3d011682016040523d82523d5f602084013e610262565b606091505b5092509050610305565b8260ff166001036102c957866001600160a01b03168585604051610291929190610441565b5f60405180830381855af49150503d805f811461025d576040519150601f19603f3d011682016040523d82523d5f602084013e610262565b60405162461bcd60e51b815260206004820152601160248201527024b73b30b634b21037b832b930ba34b7b760791b60448201526064016101f4565b8061031257815160208301fd5b5095945050505050565b6001600160a01b0381168114610330575f80fd5b50565b5f805f805f60808688031215610347575f80fd5b85356103528161031c565b945060208601359350604086013567ffffffffffffffff80821115610375575f80fd5b818801915088601f830112610388575f80fd5b813581811115610396575f80fd5b8960208285010111156103a7575f80fd5b602083019550809450505050606086013560ff811681146103c6575f80fd5b809150509295509295909350565b5f6020808352835180828501525f5b818110156103ff578581018301518582016040015282016103e3565b505f604082860101526040601f19601f8301168501019250505092915050565b5f6020828403121561042f575f80fd5b815161043a8161031c565b9392505050565b818382375f910190815291905056fea2646970667358221220de019103b75cf25a02049968f61c94ba7343d6c5df0a66e5c7d0c6096869d69264736f6c63430008150033";

export function populateDeployRailgunMech({
  railgunNeuralLink,
  salt,
}: {
  railgunNeuralLink: string;
  salt: string;
}): TransactionRequest {
  return encodeDeploySingleton({
    bytecode: railgunMechBytecode,
    constructorArgs: {
      types: ["address"],
      values: [railgunNeuralLink],
    },
    salt,
  }) as any;
}

export function predictRailgunMechAddress({
  railgunNeuralLink,
  salt,
}: {
  railgunNeuralLink: string;
  salt: string;
}) {
  return predictSingletonAddress({
    bytecode: railgunMechBytecode,
    constructorArgs: {
      types: ["address"],
      values: [railgunNeuralLink],
    },
    salt,
  });
}

// for reference: https://polygonscan.com/address/0x5c0fc3fc2eb438ada4dea189aa95874d449d8a8e#code
const railgunNeuralLinkBytecode =
  "0x60c060405234801561000f575f80fd5b5060405161047e38038061047e83398101604081905261002e91610060565b6001600160a01b039182166080521660a052610091565b80516001600160a01b038116811461005b575f80fd5b919050565b5f8060408385031215610071575f80fd5b61007a83610045565b915061008860208401610045565b90509250929050565b60805160a0516103bf6100bf5f395f8181610106015261016501525f818160a2015261012a01526103bf5ff3fe608060405234801561000f575f80fd5b5060043610610055575f3560e01c8063025e7c2714610059578063078840801461009d57806323b872dd146100c45780636352211e146100d9578063b26fb1e914610101575b5f80fd5b61008161006736600461031e565b5f602081905290815260409020546001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f35b6100817f000000000000000000000000000000000000000000000000000000000000000081565b6100d76100d2366004610350565b610128565b005b6100816100e736600461031e565b5f908152602081905260409020546001600160a01b031690565b6100817f000000000000000000000000000000000000000000000000000000000000000081565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316826001600160a01b0316148061019957507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316826001600160a01b0316145b6102065760405162461bcd60e51b815260206004820152603360248201527f4e657572616c4c696e6b3a20636f6e74726f6c2063616e206f6e6c79206265206044820152723932ba30b4b732b210313c902930b4b633bab760691b60648201526084015b60405180910390fd5b5f818152602081905260408120546001600160a01b03169081159033831480156102415750856001600160a01b0316836001600160a01b0316145b9050818061024c5750805b6102ac5760405162461bcd60e51b815260206004820152602b60248201527f4e657572616c4c696e6b3a206e6f7420617574686f72697a656420746f20736860448201526a1a599d0818dbdb9d1c9bdb60aa1b60648201526084016101fd565b83856001600160a01b0316876001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60405160405180910390a45050505f90815260208190526040902080546001600160a01b0319166001600160a01b039290921691909117905550565b5f6020828403121561032e575f80fd5b5035919050565b80356001600160a01b038116811461034b575f80fd5b919050565b5f805f60608486031215610362575f80fd5b61036b84610335565b925061037960208501610335565b915060408401359050925092509256fea2646970667358221220bca41c422c677fd86f077d97457975c2f267d6c762da8076c2392d61b8d6561d64736f6c63430008150033";

export function predictRailgunNeuralLinkAddress({
  railgunSmartWallet,
  relayAdapt,
}: {
  railgunSmartWallet: string;
  relayAdapt: string;
}) {
  return predictSingletonAddress({
    bytecode: railgunNeuralLinkBytecode,
    constructorArgs: {
      types: ["address", "address"],
      values: [railgunSmartWallet, relayAdapt],
    },
    salt: ZeroHash,
  });
}
