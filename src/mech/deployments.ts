import { Interface, keccak256, TransactionRequest, ZeroHash } from "ethers";
import {
  RailgunProxyContract,
  RelayAdaptContract,
} from "@railgun-community/shared-models";

import { getCurrentNetwork } from "../engine/engine";
import { getCurrentEthersWallet } from "../wallet/public-utils";
import {
  encodeDeploySingleton,
  predictSingletonAddress,
} from "@gnosis-guild/zodiac-core";

// for reference: https://polygonscan.com/address/0xb11ac32f9658141b1cd49e15f89879cf3dd93781#code
const railgunMechBytecode =
  "0x60c060405234801561000f575f80fd5b5060405161056338038061056383398101604081905261002e9161007c565b6001600160a01b03811660808190523060a08190526040519081527f395a37f76d5952499ce671a72044003fb77190777dbfc8c1b9521e270240f3459060200160405180910390a2506100a9565b5f6020828403121561008c575f80fd5b81516001600160a01b03811681146100a2575f80fd5b9392505050565b60805160a05161048d6100d65f395f818160c2015261010101525f818160770152610134015261048d5ff3fe608060405260043610610034575f3560e01c8063519454471461003d578063a8f4f65c14610066578063af640d0f146100b157005b3661003b57005b005b61005061004b36600461033a565b6100f2565b60405161005d91906103db565b60405180910390f35b348015610071575f80fd5b506100997f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200161005d565b3480156100bc575f80fd5b506100e47f000000000000000000000000000000000000000000000000000000000000000081565b60405190815260200161005d565b6040516331a9108f60e11b81527f0000000000000000000000000000000000000000000000000000000000000000600482015260609033906001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001690636352211e90602401602060405180830381865afa158015610179573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061019d9190610426565b6001600160a01b0316146102045760405162461bcd60e51b8152602060048201526024808201527f4f6e6c792063616c6c61626c6520627920746865204d656368206f70657261746044820152636f72202d60e01b60648201526084015b60405180910390fd5b5f8260ff165f0361027357866001600160a01b031686868660405161022a929190610448565b5f6040518083038185875af1925050503d805f8114610264576040519150601f19603f3d011682016040523d82523d5f602084013e610269565b606091505b509250905061030c565b8260ff166001036102d057866001600160a01b03168585604051610298929190610448565b5f60405180830381855af49150503d805f8114610264576040519150601f19603f3d011682016040523d82523d5f602084013e610269565b60405162461bcd60e51b815260206004820152601160248201527024b73b30b634b21037b832b930ba34b7b760791b60448201526064016101fb565b8061031957815160208301fd5b5095945050505050565b6001600160a01b0381168114610337575f80fd5b50565b5f805f805f6080868803121561034e575f80fd5b853561035981610323565b945060208601359350604086013567ffffffffffffffff8082111561037c575f80fd5b818801915088601f83011261038f575f80fd5b81358181111561039d575f80fd5b8960208285010111156103ae575f80fd5b602083019550809450505050606086013560ff811681146103cd575f80fd5b809150509295509295909350565b5f6020808352835180828501525f5b81811015610406578581018301518582016040015282016103ea565b505f604082860101526040601f19601f8301168501019250505092915050565b5f60208284031215610436575f80fd5b815161044181610323565b9392505050565b818382375f910190815291905056fea26469706673582212205a073499caa1e825ca819d871cc9307d373b835b7fda0adb063fd10819a99c2b64736f6c63430008150033";

// for reference: https://polygonscan.com/address/0x5c0fc3fc2eb438ada4dea189aa95874d449d8a8e#code
const railgunNeuralLinkBytecode =
  "0x608060405234801561000f575f80fd5b506102198061001d5f395ff3fe608060405234801561000f575f80fd5b506004361061004a575f3560e01c8063025e7c271461004e578063095ea7b31461009257806323b872dd146100a65780636352211e146100b9575b5f80fd5b61007661005c366004610150565b5f602081905290815260409020546001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f35b6100a46100a0366004610182565b5050565b005b6100a46100b43660046101aa565b6100e1565b6100766100c7366004610150565b5f908152602081905260409020546001600160a01b031690565b80826001600160a01b0316846001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60405160405180910390a45f90815260208190526040902080546001600160a01b0319166001600160a01b039290921691909117905550565b5f60208284031215610160575f80fd5b5035919050565b80356001600160a01b038116811461017d575f80fd5b919050565b5f8060408385031215610193575f80fd5b61019c83610167565b946020939093013593505050565b5f805f606084860312156101bc575f80fd5b6101c584610167565b92506101d360208501610167565b915060408401359050925092509256fea2646970667358221220b98d055b0ab1965c225e0ef10bf0bc56d0aded9f5a63a52d36411314ae99b30964736f6c63430008150033";

export function ralgunSmartWalletAddress() {
  return RailgunProxyContract[getCurrentNetwork()];
}

export function relayAdaptAddress() {
  return RelayAdaptContract[getCurrentNetwork()];
}

export function mechAddress() {
  return predictSingletonAddress({
    bytecode: railgunMechBytecode,
    constructorArgs: { types: ["address"], values: [nftAddress()] },
    salt: mechDeploymentSalt(),
  });
}

export function nftAddress() {
  return predictSingletonAddress({
    bytecode: railgunNeuralLinkBytecode,
    constructorArgs: { types: [], values: [] },
    salt: ZeroHash,
  });
}

export function nftTokenId() {
  const address = mechAddress();
  return BigInt(address);
}

export function populateMechDeployment(): TransactionRequest {
  return encodeDeploySingleton({
    bytecode: railgunMechBytecode,
    constructorArgs: {
      types: ["address"],
      values: [nftAddress()],
    },
    salt: mechDeploymentSalt(),
  }) as TransactionRequest;
}

export function populateMint(): TransactionRequest {
  /*
   * For now this is just a transfer, but the real contract will really require a mint
   */
  const iface = new Interface([
    "function transferFrom(address from, address to, uint256 tokenId)",
  ]);

  return {
    to: nftAddress(),
    data: iface.encodeFunctionData("transferFrom", [
      relayAdaptAddress(),
      relayAdaptAddress(),
      nftTokenId(),
    ]),
    value: 0,
  };
}

export function mechDeploymentSalt() {
  const wallet = getCurrentEthersWallet();
  return keccak256(wallet.signMessageSync("RailgunMech Deployment"));
}
